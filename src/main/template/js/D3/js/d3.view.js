var links =  [
    {
        source: "OMAHA七巧板医学术语(OMAHA医学术语)",
        rela: "OMAHA概念ID",
        target: "11679591",
        type: "resolved",
        group: 0
    },
    {
        source: "OMAHA七巧板医学术语(OMAHA医学术语)",
        rela: "名称",
        target: "OMAHA七巧板医学术语",
        type: "resolved",
        group: 0
    },
    {
        source: "化学药品(药品)",
        rela: "OMAHA概念ID",
        target: "12147199",
        type: "resolved",
        group: 0
    },
    {
        source: "化学药品(药品)",
        rela: "名称",
        target: "化学药品(物质)",
        type: "resolved",
        group: 0
    },
    {
        source: "化学药品(药品)",
        rela: "子类",
        target: "药品(药品)",
        type: "resolved",
        group: 0
    },
    {
        source: "心脏病治疗药(药品)",
        rela: "OMAHA概念ID",
        target: "12351908",
        type: "resolved",
        group: 0
    },
    {
        source: "心脏病治疗药(药品)",
        rela: "名称",
        target: "心脏病治疗药",
        type: "resolved",
        group: 0
    },
    {
        source: "心脏病治疗药(药品)",
        rela: "子类",
        target: "心血管系统用药(药品)",
        type: "resolved",
        group: 0
    },
    {
        source: "心血管系统用药(药品)",
        rela: "OMAHA概念ID",
        target: "12352236",
        type: "resolved",
        group: 0
    },
    {
        source: "心血管系统用药(药品)",
        rela: "子类",
        target: "化学药品(药品)",
        type: "resolved",
        group: 0
    },
    {
        source: "心血管系统用药(药品)",
        rela: "别称",
        target: "循环系统用药物(药品)",
        type: "resolved",
        group: 0
    },
    {
        source: "心血管系统用药(药品)",
        rela: "名称",
        target: "心血管系统用药",
        type: "resolved",
        group: 0
    },
    {
        source: "心血管药(物质)",
        rela: "OMAHA概念ID",
        target: "11327990",
        type: "resolved",
        group: 0
    },
    {
        source: "心血管药(物质)",
        rela: "名称",
        target: "心血管药",
        type: "resolved",
        group: 0
    },
    {
        source: "心血管药(物质)",
        rela: "子类",
        target: "药物或药剂(物质)",
        type: "resolved",
        group: 0
    },
    {
        source: "氯达香豆素(物质)",
        rela: "OMAHA概念ID",
        target: "18537836",
        type: "resolved",
        group: 0
    },
    {
        source: "氯达香豆素(物质)",
        rela: "名称",
        target: "氯达香豆素",
        type: "resolved",
        group: 0
    },
    {
        source: "氯达香豆素(物质)",
        rela: "子类",
        target: "血管舒张药(物质)",
        type: "resolved",
        group: 0
    },
    {
        source: "氯达香豆素(药品)",
        rela: "OMAHA概念ID",
        target: "11784193",
        type: "resolved",
        group: 0
    },
    {
        source: "氯达香豆素(药品)",
        rela: "名称",
        target: "氯达香豆素",
        type: "resolved",
        group: 0
    },
    {
        source: "氯达香豆素(药品)",
        rela: "有效成分",
        target: "氯达香豆素(物质)",
        type: "resolved",
        group: 0
    },
    {
        source: "氯达香豆素(药品)",
        rela: "子类",
        target: "治疗心脏病用血管舒张药(药品)",
        type: "resolved",
        group: 0
    },
    {
        source: "治疗心脏病用血管舒张药(药品)",
        rela: "OMAHA概念ID",
        target: "12350591",
        type: "resolved",
        group: 0
    },
    {
        source: "治疗心脏病用血管舒张药(药品)",
        rela: "子类",
        target: "心脏病治疗药(药品)",
        type: "resolved",
        group: 0
    },
    {
        source: "治疗心脏病用血管舒张药(药品)",
        rela: "名称",
        target: "治疗心脏病用血管舒张药",
        type: "resolved",
        group: 0
    },
    {
        source: "物质(物质)",
        rela: "OMAHA概念ID",
        target: "11447593",
        type: "resolved",
        group: 0
    },
    {
        source: "物质(物质)",
        rela: "子类",
        target: "OMAHA七巧板医学术语(OMAHA医学术语)",
        type: "resolved",
        group: 0
    },
    {
        source: "物质(物质)",
        rela: "名称",
        target: "物质",
        type: "resolved",
        group: 0
    },
    {
        source: "药品(药品)",
        rela: "OMAHA概念ID",
        target: "12352262",
        type: "resolved",
        group: 0
    },
    {
        source: "药品(药品)",
        rela: "子类",
        target: "OMAHA七巧板医学术语(OMAHA医学术语)",
        type: "resolved",
        group: 0
    },
    {
        source: "药品(药品)",
        rela: "名称",
        target: "药品(物质)",
        type: "resolved",
        group: 0
    },
    {
        source: "药品(药品)",
        rela: "别称",
        target: "药物(物质)",
        type: "resolved",
        group: 0
    },
    {
        source: "药物或药剂(物质)",
        rela: "OMAHA概念ID",
        target: "1269287",
        type: "resolved",
        group: 0
    },
    {
        source: "药物或药剂(物质)",
        rela: "子类",
        target: "物质(物质)",
        type: "resolved",
        group: 0
    },
    {
        source: "药物或药剂(物质)",
        rela: "别称",
        target: "药品(物质)",
        type: "resolved",
        group: 0
    },
    {
        source: "药物或药剂(物质)",
        rela: "别称",
        target: "药物(物质)",
        type: "resolved",
        group: 0
    },
    {
        source: "药物或药剂(物质)",
        rela: "名称",
        target: "药物或药剂",
        type: "resolved",
        group: 0
    },
    {
        source: "血管舒张药(物质)",
        rela: "OMAHA概念ID",
        target: "11671305",
        type: "resolved",
        group: 0
    },
    {
        source: "血管舒张药(物质)",
        rela: "别称",
        target: "血管扩张剂(物质)",
        type: "resolved",
        group: 0
    },
    {
        source: "血管舒张药(物质)",
        rela: "名称",
        target: "血管舒张药",
        type: "resolved",
        group: 0
    },
    {
        source: "血管舒张药(物质)",
        rela: "子类",
        target: "降压药(物质)",
        type: "resolved",
        group: 0
    },
    {
        source: "降压药(物质)",
        rela: "OMAHA概念ID",
        target: "11651423",
        type: "resolved",
        group: 0
    },
    {
        source: "降压药(物质)",
        rela: "子类",
        target: "心血管药(物质)",
        type: "resolved",
        group: 0
    },
    {
        source: "降压药(物质)",
        rela: "名称",
        target: "降压药",
        type: "resolved",
        group: 0
    }
]

var nodes = {};
var data;
var searchType = "";
$(function () {
    (function () {
        $('#kg').css("font-weight", "bold");
        getData(links);
        svg(links);
    })();


    // var flag = true;
    // $('#search').on('compositionstart',function(){
    //     flag = false;
    // });
    // $('#search').on('compositionend',function(){
    //     flag = true;
    // });

    //关键词索引
    // $("#kgKeyWord").on("change", function () {

    //     $("#choose").hide();
    //     $("#choose").html("");
    //     $("#choose").hide();
    //     var keyword = $("#search").val();
    //     if (keyword != ""){

    //         console.log(1234)
    //         getTerm(keyword);
    //     }
    // })

    //搜索框焦点改变事件
    // $("#kgKeyWord").bind("input propotychange", function () {
    //
    //     if(memberType!=2){
    //         var text = '汇知医学知识图谱可视化搜索目前仅对高级版机构开放，详情请参阅<a href="/user/order?type=member" target="_blank" style="color:#4193EE;">服务权益</a>。';
    //         lackOfCompetence(text);
    //         return false;
    //     }else{
    //         if(identitys == 1 || identitys == 2 || identitys == 3 || identitys == 5){
    //             var text = '汇知医学知识图谱可视化搜索目前仅对高级版机构开放，详情请参阅<a href="/user/order?type=member" target="_blank" style="color:#4193EE;">服务权益</a>。';
    //             lackOfCompetence(text);
    //             return false;
    //         }
    //     }
    //
    //     var keyWord = $(this).val();
    //     var type = $(this).attr("data-type");
    //     $(".kgSearchHint ul").html("");
    //     $(".kgSearchHint").hide();
    //     $(".kgResultHint").hide();
    //
    //
    //     if (keyWord != "") {
    //         getTerm(keyWord, type);
    //     } else {
    //         $(".kgSearchHint").hide();
    //         $(".kgResultHint").hide();
    //         $(".kgSearchInput").css("border-top", "");
    //         $(".kgSearchInput").css("border-left", "");
    //     }
    // });
});

var timestampFlag = 0;

function getTerm(keyword, type) {
    var timestamp = (new Date()).valueOf();
    var request = {text: keyword, type: type, timestamp: timestamp};
    searchType = type;
    $.ajax({
        url: kgKeyWordUrl,
        type: "POST",
        // contentType: "application/json",
        data: request,
        success: function (data) {
            if (data.ok) {
                if ($("#kgKeyWord").val() == "") {
                    return;
                }
                var names = [];
                // var objs = eval('(' + data.result + ')');
                //
                var list = '';
                if (data.result) {

                    if (data.result.length > 0) {


                        $.each(data.result, function (ids, obj, i) {
                            var name = "'" + obj.name + "'";
                            var semanticTag = "'" + obj.semanticTag + "'";
                            var eid = "'" + obj.eid + "'";
                            var num = ids + 1;
                            // list +='<li class="kgProposal searchTitleList" style="line-height:22px" data-num="'+num+'" onclick="getDetail(' + eid + ','+ name +','+ semanticTag +');">' + obj.name + '('+obj.semanticTag+')</li>';
                            list += '<li class="kgProposal searchTitleList" style="line-height:22px" data-num="' + num + '" onclick="getDetail(' + eid + ',' + name + ',' + semanticTag + ',' + "'" + type + "'" + ');"><span style="float:left">' + obj.name + '</span><span style="float:right;margin-right:10px;">' + obj.semanticTag + '</span></li>';
                        });
                    } else {
                        list += '<li class="kgProposal searchTitleList" style="line-height:22px"><span>无法搜索到相关概念，请更换搜索词或者输入该词相关同义词重新搜索</span></li>';
                    }

                    if (data.timestamp > timestampFlag) {
                        if (data.result.length > 0) {
                            $(".kgResultHint").show();
                        } else {
                            $(".kgResultHint").hide();
                        }

                        $(".kgSearchHint ul").html(list);
                        $(".kgSearchHint").show();
                        $(".kgSearchInput").css("border-top", "1px solid #4A90E2");
                        $(".kgSearchInput").css("border-left", "1px solid #4A90E2");
                        timestampFlag = data.timestamp;
                    }

                } else {
                    $(".kgSearchHint").hide();
                    $(".kgResultHint").hide();
                    $(".kgSearchInput").css("border-top", "");
                    $(".kgSearchInput").css("border-left", "");
                }


            } else {

                $(".hintBody span").html('汇知医学知识图谱可视化搜索目前仅对高级版机构开放，详情请参阅<a href="/user/order?type=member" target="_black" style="color:#4A90E2">服务权益</a>。');
                $("#myAddTplHint").modal("show");
                // $(".kgSearchHint").html('<li class="kgProposal">' + data.message + '</li>');
                // $(".kgSearchHint").show();
                // $(".kgSearchInput").css("border-top","1px solid #4A90E2");
                // $(".kgSearchInput").css("border-left","1px solid #4A90E2");
            }

        }
    });
}

function getData(links) {
    $(".kgStickyNoteBtn").remove();
    nodes = {};
    $("#d3").remove();
    data = links;
    links.forEach(function (link) {
        link.source = nodes[link.source] || (nodes[link.source] = {name: link.source});
        link.target = nodes[link.target] || (nodes[link.target] = {name: link.target});
    });
    var attr = "";
    var attrs = [];
    var semanticTag = "";
    var semanticTags = [];
    var input1 = "";
    var input2 = "";
    var names = [];
    $.each(links, function (ids, obj) {
        // if (obj.rela != attr) {
        if (attrs.indexOf(obj.rela) == -1 && obj.rela != "" && obj.rela != "OMAHA概念ID") {

            input1 += '<button class="kgStickyNoteBtn kgAttr kgStickyNoteBtnSelect" data-num="1">' + obj.rela + '</button>';

            $("#kgWrap .kgStickyNoteBox").html(input1);
            // attr = obj.rela;
            attrs.push(obj.rela);
        }
        if (names.indexOf(obj.source.name) == -1) {
            names.push(obj.source.name)
        }
        // if (obj.semanticTag != semanticTags) {
        if (semanticTags.indexOf(obj.semanticTag) == -1) {

            if (obj.semanticTag != null && obj.semanticTag != "null") {

                input2 += '<button class="kgStickyNoteBtn kgSemanticTag kgStickyNoteBtnSelect" data-num="1">' + obj.semanticTag + '</button>';
                // console.log(input)
            }

            $("#kgWrap2 .kgStickyNoteBox").html(input2);
            // semanticTag = obj.semanticTag;
            semanticTags.push(obj.semanticTag);
        }
    });


    // 筛选属性关系
    $(".kgAttr").on("click", function () {
        $("#d3").remove();
        var dataNum = $(this).attr("data-num");
        var val = $(this).text();
        if (dataNum == 1) {
            var new_links = [];
            var new_links1 = [];
            var names2 = [];
            $.each(links, function (ids, obj) {
                if (val != obj.rela) {
                    if (names2.indexOf(obj.source.name) == -1) {
                        names2.push(obj.source.name)
                    }
                    new_links.push(obj);
                } else {
                    delete nodes[obj.target.name];
                }
            });
            var del = [];
            $.each(names, function (ids, obi) {
                if (names2.indexOf(obi) == -1) {
                    del.push(parseInt(obi))
                }
            });
            $.each(new_links, function (ids, obo) {
                if (del.indexOf(obo.groups) == -1) {
                    new_links1.push(obo)
                }
            });
            links = new_links1;

        } else {
            var new_links = [];
            // console.log(links)
            var judge_links = data;

            var new1_links = [];
            var new2_links = [];

            $(this).parent().find("button[data-num=0]").each(function (i) {
                var vals = $(this).text();
                if (vals != val) {
                    new1_links.push(vals)
                }
            });

            $.each(judge_links, function (ids, obj) {
                if (new1_links.indexOf(obj.rela) == -1) {
                    new2_links.push(obj);
                } else {
                    delete nodes[obj.target.name];
                }
            });

            var data2 = new2_links;

            nodes = {};
            $.each(new2_links, function (ids, obj) {
                nodes[obj.target.name] = obj.target;
                if (ids == 0) {
                    nodes[obj.source.name] = obj.source;
                }
            });


            links = new2_links;

        }

        svg(links);

    });

    //筛选值的语义类型
    $(".kgSemanticTag").on("click", function () {
        $("#d3").remove();
        var val = $(this).text();
        var dataNum = $(this).attr("data-num");

        if (dataNum == 1) {
            var new_links = [];
            var new_links1 = [];
            var names2 = [];
            $.each(links, function (ids, obj) {
                if (val != obj.semanticTag) {
                    if (names2.indexOf(obj.source.name) == -1) {
                        names2.push(obj.source.name)
                    }
                    new_links.push(obj);
                } else {
                    delete nodes[obj.target.name];
                }
            });
            var del = [];
            $.each(names, function (ids, obi) {
                if (names2.indexOf(obi) == -1) {
                    del.push(parseInt(obi))
                }
            });
            $.each(new_links, function (ids, obo) {
                if (del.indexOf(obo.groups) == -1) {
                    new_links1.push(obo)
                }
            });
            links = new_links1;
        } else {
            var new_links = [];

            var judge_links = data;

            var new1_links = [];
            var new2_links = [];

            $(this).parent().find("button[data-num=0]").each(function (i) {
                var vals = $(this).text();
                if (vals != val) {
                    new1_links.push(vals)
                }
            });

            $.each(judge_links, function (ids, obj) {
                if (new1_links.indexOf(obj.semanticTag) == -1) {
                    new2_links.push(obj);
                } else {
                    delete nodes[obj.target.name];
                }
            });

            var data2 = new2_links;
            nodes = {};
            $.each(new2_links, function (ids, obj) {
                nodes[obj.target.name] = obj.target;

                if (ids == 0) {
                    nodes[obj.source.name] = obj.source;
                }
            });


            links = new2_links;
        }


        svg(links);
    });


    //全选和取消全选
    $("#kgStickyNoteAll").click(function () {

        if ($(this).is(':checked')) {
            $(this).parent().parent().next("div").find(".kgStickyNoteBtn").attr("data-num", 1);
            $(this).parent().parent().next("div").find(".kgStickyNoteBtn").addClass("kgStickyNoteBtnSelect");
            $("#d3").remove();
            var new_links = [];
            // console.log(links)
            var judge_links = data;
            var new1_links = [];
            var new2_links = [];

            $(this).parent().parent().next("div").find("button[data-num=0]").each(function (i) {
                var vals = $(this).text();
                new1_links.push(vals)

            });

            $.each(judge_links, function (ids, obj) {
                if (new1_links.indexOf(obj.rela) == -1) {
                    new2_links.push(obj);
                } else {
                    delete nodes[obj.target.name];
                }
            });

            var data2 = new2_links;

            nodes = {};
            $.each(new2_links, function (ids, obj) {
                nodes[obj.target.name] = obj.target;

                if (ids == 0) {
                    nodes[obj.source.name] = obj.source;
                }
            });
            links = new2_links;
            svg(links);
        } else {
            $(this).parent().parent().next("div").find(".kgStickyNoteBtn").attr("data-num", 0);
            $(this).parent().parent().next("div").find(".kgStickyNoteBtn").removeClass("kgStickyNoteBtnSelect");
            $("#d3").remove();

            var new_links = [];
            // console.log(links)
            var judge_links = data;

            var new1_links = [];
            var new2_links = [];
            var names2 = [];
            var new_links2 = [];
            $(this).parent().parent().next("div").find("button[data-num=0]").each(function (i) {
                var vals = $(this).text();
                new1_links.push(vals)

            });
            $.each(judge_links, function (ids, obj) {

                if (new1_links.indexOf(obj.rela) == -1) {
                    if (names2.indexOf(obj.source.name) == -1) {
                        names2.push(obj.source.name)
                    }
                    new2_links.push(obj);
                } else {
                    delete nodes[obj.target.name];
                }
            });

            var data2 = new2_links;

            nodes = {};
            var del = [];
            $.each(names, function (ids, obi) {
                if (names2.indexOf(obi) == -1) {
                    del.push(parseInt(obi))
                }
            });
            $.each(new2_links, function (ids, obj) {
                nodes[obj.target.name] = obj.target;

                if (ids == 0) {
                    nodes[obj.source.name] = obj.source;
                }
                if (del.indexOf(obj.groups) == -1) {
                    new_links2.push(obj)
                }
            });
            links = new_links2;
            svg(links);
        }
    });

    //全选和取消全选
    $("#kgStickyNoteAll2").click(function () {

        if ($(this).is(':checked')) {
            $(this).parent().parent().next("div").find(".kgStickyNoteBtn").attr("data-num", 1);
            $(this).parent().parent().next("div").find(".kgStickyNoteBtn").addClass("kgStickyNoteBtnSelect");
            $("#d3").remove();
            var new_links = [];

            var judge_links = data;

            var new1_links = [];
            var new2_links = [];
            $(this).parent().parent().next("div").find("button[data-num=0]").each(function (i) {
                var vals = $(this).text();
                new1_links.push(vals)

            })

            $.each(judge_links, function (ids, obj) {

                if (new1_links.indexOf(obj.semanticTag) == -1) {
                    new2_links.push(obj);
                } else {
                    delete nodes[obj.target.name];
                }
            });

            var data2 = new2_links;

            nodes = {};
            $.each(new2_links, function (ids, obj) {
                nodes[obj.target.name] = obj.target;
                if (ids == 0) {
                    nodes[obj.source.name] = obj.source;
                }
            });

            links = new2_links;
            svg(links);

        } else {
            $(this).parent().parent().next("div").find(".kgStickyNoteBtn").attr("data-num", 0);
            $(this).parent().parent().next("div").find(".kgStickyNoteBtn").removeClass("kgStickyNoteBtnSelect");
            $("#d3").remove();
            var new_links = [];

            var judge_links = data;

            var new1_links = [];
            var new2_links = [];
            var names2 = [];
            var new_links2 = [];
            $(this).parent().parent().next("div").find("button[data-num=0]").each(function (i) {
                var vals = $(this).text();
                new1_links.push(vals)
            })

            $.each(judge_links, function (ids, obj) {

                if (new1_links.indexOf(obj.semanticTag) == -1) {
                    if (names2.indexOf(obj.source.name) == -1) {
                        names2.push(obj.source.name)
                    }
                    new2_links.push(obj);
                } else {
                    delete nodes[obj.target.name];
                }
            });

            var data2 = new2_links;

            nodes = {};
            var del = [];
            $.each(names, function (ids, obi) {
                if (names2.indexOf(obi) == -1) {
                    del.push(parseInt(obi))
                }
            });
            $.each(new2_links, function (ids, obj) {
                nodes[obj.target.name] = obj.target;

                if (ids == 0) {
                    nodes[obj.source.name] = obj.source;
                }
                if (del.indexOf(obj.groups) == -1) {
                    new_links2.push(obj)
                }
            });
            links = new_links2;
            svg(links);
        }
    })
}

function getDetail(eid, name, semanticTag, type) {
    if (semanticTag == "ICD-10" || semanticTag == "ICD-9-CM-3"){
        var arrays = semanticTag.split("-");
        if (arrays[1] == "10"){
           arrays[1] = "";
        }
        window.open("http://term.omaha.org.cn/?/search/q-"+ base64Encode(name) +"__t-topics__ty-icd"+arrays[1]);
        return;
    }
    $(".kgSearchHint").hide();
    $(".kgResultHint").hide();
    $(".kgSearchInput").css("border-top", "");
    $(".kgSearchInput").css("border-left", "");
    $("#kgKeyWord").val(name);
    searchType = type;
    var request = {eid: eid, name: semanticTag, type: type};
    $.ajax({
        url: kgKeyWordDetail,
        type: "POST",
        // contentType: "application/json",
        data: request,
        success: function (data) {
            // console.log(data)
            if (data.ok) {
                // var objs = eval('(' + data.result + ')');

                if (data.result) {
                    var datas = [];
                    $.each(data.result[0], function (ids, obj) {
                        var child = {};
                        if (obj.groups != 0) {
                            child["source"] = obj.entityInfo[0]['name'];
                            child["target"] = (obj.groups).toString();
                            child["rela"] = '';
                            child["type"] = "resolved";
                            child["groups"] = obj.groups;
                            child["realName"] = obj.val[0]['realName'];
                            if (typeof(obj.val[0]) != 'string') {
                                child['entityId'] = obj.val[0]['valId'];
                                var index = obj.val[0]['name'].lastIndexOf("\(");
                                tex = obj.val[0]['name'].substring(index + 1, obj.val[0]['name'].length - 1);
                                child['relation'] = tex;
                            } else {
                                child['entityId'] = '非实体';
                                child['relation'] = "";
                            }
                            datas.push(child);
                            // child["source"] = (obj.groups).toString();
                            // if(obj.val[0]['name']==undefined){
                            //     child["target"] = obj.val[0];
                            // }else{
                            //     child["target"] = obj.val[0]['name'];
                            // }
                            // child["rela"] = obj.relation[0]['name'];
                            // child["type"] = "resolved";
                            // child["groups"] = obj.groups;
                            // child["semanticTag"] = obj.semanticTag;
                            // datas.push(child)
                        } else {
                            child["source"] = obj.entityInfo[0]['name'];
                            if (obj.val[0]['name'] == undefined) {
                                child["target"] = obj.val[0];
                            } else {
                                child["target"] = obj.val[0]['name'];
                            }
                            child["rela"] = obj.relation[0]['name'];
                            child["type"] = "resolved";
                            child["groups"] = obj.groups;
                            child["realName"] = obj.val[0]['realName'];
                            child["semanticTag"] = obj.semanticTag;
                            if (typeof(obj.val[0]) != 'string') {
                                child['entityId'] = obj.val[0]['valId'];
                                index = obj.val[0]['name'].lastIndexOf("\(");
                                tex = obj.val[0]['name'].substring(index + 1, obj.val[0]['name'].length - 1);
                                child['relation'] = tex;
                            } else {
                                child['entityId'] = '非实体';
                                child['relation'] = "";
                            }
                            datas.push(child)
                        }
                    });
                    $.each(data.result[0], function (ids, obj) {
                        var child = {};
                        if (obj.groups != 0) {
                            child["source"] = (obj.groups).toString();
                            if (obj.val[0]['name'] == undefined) {
                                child["target"] = obj.val[0] + (obj.groups).toString();
                            } else {
                                child["target"] = obj.val[0]['name'] + (obj.groups).toString();
                            }
                            child["rela"] = obj.relation[0]['name'];
                            child["type"] = "resolved";
                            child["groups"] = obj.groups;
                            child["semanticTag"] = obj.semanticTag;
                            child["realName"] = obj.val[0]['realName'];
                            if (typeof(obj.val[0]) != 'string') {
                                child['entityId'] = obj.val[0]['valId'];
                                var index = obj.val[0]['name'].lastIndexOf("\(");
                                tex = obj.val[0]['name'].substring(index + 1, obj.val[0]['name'].length - 1);
                                child['relation'] = tex;
                            } else {
                                child['entityId'] = '非实体';
                                child['relation'] = "";
                            }
                            datas.push(child)
                        }
                    });
                    getData(datas);
                    svg(datas);
                }
            } else {
                if (data.code == 4051) {
                    var message = "操作过于频繁，请稍后再试。";
                    $("#publicHint5").modal("show");
                    $(".publicHint5Content span").text(message);
                    setTimeout(function () {
                        $("#publicHint5").modal("hide");
                    }, 1000);
                }
            }
        }
    });
}

function svg(links) {
    var colors = {
        0: '#D8E8F5', 1: '#CCCCFF', 2: '#F15E00', 3: '#30426A', 4: '#5270DE', 5: '#9142A1', 6: '#3EA27',
        7: '#F5A623', 8: '#91D5D0', 9: '#B391D5', 10: '#5BB2F0', 11: '#EF9898', 12: '#F2EC8A',
        13: '#B8E2A8', 14: '#E8C1E3', 15: '#91BEDF', 16: '#6A2D4C', 17: '#DAEFF4', 18: '#C52C31',
        19: '#AF7A50', 20: '#5EB97C', 21: '#80C2B4', 22: '#A7C4A5', 23: '#69916F', 24: '#A33035',
        25: '#774730', 26: '#A45A32', 27: '#B1D140', 28: '#853059', 29: '#EB5E57', 30: '#224747',
        31: '#B888BA', 32: '#C5B9C7', 33: '#F5A63C', 34: '#AB9E71', 35: '#929285', 36: '#20677D',
        37: '#ABBCBE', 38: '#6A2831', 39: '#407885', 40: '#207646', 41: '#F6D961', 42: '#E09C64',
        43: '#D18028', 44: '#2A406E', 45: '#B14D81', 46: '#39412C', 47: '#408B77', 48: '#707068',
        49: '#CEB5A1', 50: '#A76C66', 51: '#B4BAC8', 52: '#877195', 53: '#5FB6C7', 54: '#F7B96E',
        55: '#FBD3A0', 56: '#3B3C37', 57: '#95864A', 58: '#E1CADF', 59: '#E37F7B', 60: '#C4CC9D',
        61: '#F29689', 62: '#95B730', 63: '#218A71', 64: '#E0E9A7', 65: '#5B838D', 66: '#C8C8BD',
        67: '#49242C', 68: '#86A988', 69: '#AECA61', 70: '#706135', 71: '#42304A', 72: '#B69590',
        73: '#D594AA', 74: '#7F9C97', 75: '#8AADD7', 76: '#B03232', 77: '#2A3B81', 78: '#998CA0',
        79: '#CCBD9C', 80: '#F29A2B', 81: '#67BFA6', 82: '#98D4DF', 83: '#8598B8', 84: '#839144',
        85: '#87C793', 86: '#FFFFCC', 87: '#CCFFFF', 88: '#FFCCCC', 89: '#FFFF99', 90: '#FF9966',
        91: '#FFCC99', 92: '#CCFF99', 93: '#CCFFCC', 94: '#99CC99', 95: '#99CCCC', 96: '#FF6666',
        97: '#CCCCCC', 98: '#FF7CFD',99: '#3CB3FF', 100: '#65FFBD'
    };
    var group = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16,
        17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29,
        30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,
        43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56,
        57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
        71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85,
        86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100
    ];
    var width = $(".kgView-box").width();
    var num = getUrlParam("num");

    var height = $(window).height();
    var force = d3.layout.force()
        .nodes(d3.values(nodes))
        .links(links)
        .size([width, height])
        .linkDistance(180)
        .charge(-1500)
        .on("tick", tick)
        .start();

    var svg = d3.select("#svg").append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr('id', 'd3')
        .attr("z-index", 1);

    var marker =
        svg.append("marker")
            .attr("id", "resolved")
            .attr("markerUnits", "userSpaceOnUse")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 32)
            .attr("refY", -1)
            .attr("markerWidth", 12)
            .attr("markerHeight", 12)
            .attr("orient", "auto")
            .attr("stroke-width", 2)
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr('fill', '#000000');

    var edges_line = svg.selectAll(".edgepath")
        .data(force.links())
        .enter()
        .append("path")
        .attr({
            'd': function (d) {
                return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y
            },
            'class': 'edgepath',
            'id': function (d, i) {
                return 'edgepath' + i;
            }
        })
        .style("stroke", function (d) {
            var lineColor;
            lineColor = "#B43232";
            return lineColor;
        })
        .style("pointer-events", "none")
        .style("stroke-width", 0.5)
        .attr("marker-end", "url(#resolved)");

    var edges_text = svg.append("g").selectAll(".edgelabel")
        .data(force.links())
        .enter()
        .append("text")
        .style("pointer-events", "none")
        .attr({
            'class': 'edgelabel',
            'id': function (d, i) {
                return 'edgepath' + i;
            },
            'dx': 80,
            'dy': 0
        });

    edges_text.append('textPath')
        .attr('xlink:href', function (d, i) {
            return '#edgepath' + i
        })
        .style("pointer-events", "none")
        .text(function (d) {
            return d.rela;
        });
    var circle = svg.append("g").selectAll("circle")
        .data(force.nodes())
        .enter().append("circle")
        .style("fill", function (node) {
            // console.log(node)
            var color;
            // if (node.index == 1){
            //     node.index = 0
            // }else if (node.index == 0){
            //     node.index = 1
            // }
            if (node.index >= 0) {
                // console.log(node)
                // var link = [];
                $.each(links, function (ids, obs) {
                    // console.log(obs['source']['name']);
                    if (node.name == obs['target']['name']) {
                        // console.log(obs)
                        link = obs
                    }
                });
                // console.log(link.target)
                if (typeof(link) != "undefined") {
                    if (group.indexOf(link.groups) != -1) {
                        color = colors[link.groups];
                        // color = "#f5e74c";
                    } else {
                        color = "#D8E8F5";
                    }
                }
            } else {
                color = "#D8E8F5";
            }

            return color;
        })
        .style('stroke', function (node) {
            var color;
            if (node.index != 0) {
                var link = links[node.index - 1];
                if (typeof(link) != "undefined") {
                    if (link.rela == "代表作品") {
                        color = "#49cbc8";
                    } else {
                        color = "#A254A2";
                    }
                }
            } else {
                color = "#A254A2";
            }
            return color;
        })
        .attr("r", function (node) {
            var r;
            if (node.name.length < 3) {
                if (group.indexOf(parseInt(node.name)) != -1) {
                    r = "1";
                } else {
                    r = "28";
                }
            } else {
                r = "28";
            }

            return r;
        })
        .on("click", function (node) {
            edges_line.style("stroke-width", function (line) {
                if (line.source.name == node.name || line.target.name == node.name) {
                    return 4;
                } else {
                    return 0.5;
                }
            });
        })
        .attr("onclick", function (node) {
            var tex = "";
            $.each(links, function (ids, obj) {
                if (obj.target.name == node.name) {
                    if (typeof(obj.entityId) != 'undefined' && obj.entityId != "非实体") {
                        tex = "getDetail('" + obj.entityId + "','" + obj.realName + "','" + obj.semanticTag + "','" + searchType + "')";
                    } else {
                        tex = "";
                    }
                }
            });
            return tex;
        })
        .call(force.drag);

    var text = svg.append("g").selectAll("text")
        .data(force.nodes())
        .enter()
        .append("text")
        .attr("dy", ".35em")
        .attr("text-anchor", "middle")
        .style('fill', function (node) {
            var color;
            var link = links[node.index];
            // color = "#A254A2";
            color = "#476da2";
            return color;
        }).attr('x', function (d) {
            var re_en = /[a-zA-Z]+/g;
            if (d.name.match(re_en)) {
                d3.select(this).append('tspan')
                    .attr('x', 0)
                    .attr('y', 2)
                    .text(function () {
                        var tex = "";
                        if (d.name.indexOf(")") != -1) {
                            var index = d.name.lastIndexOf("\)");
                            tex = d.name.substring(0, index + 1);
                        } else {
                            tex = d.name
                        }
                        return tex;
                    });
            } else if (d.name.length <= 4) {
                d3.select(this).append('tspan')
                    .attr('x', 0)
                    .attr('y', 2)
                    .style("font-size", function () {
                        if (d.name.length < 3 && group.indexOf(parseInt(d.name)) != -1) {
                            return "0px";
                        }
                    })
                    .text(function () {
                        var tex = "";
                        if (d.name.indexOf(")") != -1) {
                            var index = d.name.lastIndexOf("\)");
                            tex = d.name.substring(0, index + 1);
                        } else {
                            tex = d.name
                        }
                        return tex;
                    });
            } else {
                var top = d.name.substring(0, 4);
                var bot = d.name.substring(4, d.name.length);

                d3.select(this).text(function () {
                    return '';
                });

                d3.select(this).append('tspan')
                    .attr('x', 0)
                    .attr('y', -7)
                    .text(function () {
                        var tex = "";
                        if (top.indexOf(")") != -1) {
                            var index = top.lastIndexOf("\)");
                            tex = top.substring(0, index + 1);
                        } else {
                            tex = top
                        }
                        return tex;
                    });

                d3.select(this).append('tspan')
                    .attr('x', 0)
                    .attr('y', 10)
                    .text(function () {
                        var tex = "";
                        if (bot.indexOf(")") != -1) {
                            var index = bot.lastIndexOf("\)");
                            tex = bot.substring(0, index + 1);
                        } else {
                            tex = bot
                        }
                        return tex;
                    });
            }
        });

    function tick() {
        circle.attr("transform", transform1);
        text.attr("transform", transform2);

        edges_line.attr('d', function (d) {
            var path = 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
            return path;
        });

        edges_text.attr('transform', function (d, i) {
            if (d.target.x < d.source.x) {
                bbox = this.getBBox();
                rx = bbox.x + bbox.width / 2;
                ry = bbox.y + bbox.height / 2;
                return 'rotate(180 ' + rx + ' ' + ry + ')';
            } else {
                return 'rotate(0)';
            }
        });
    }

    function linkArc(d) {
        return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y
    }

    function transform1(d) {
        return "translate(" + d.x + "," + d.y + ")";
    }

    function transform2(d) {
        return "translate(" + (d.x) + "," + d.y + ")";
    }
}

function clickEntity(eid) {
    alert(eid)
}

function unique1(arr) {
    var hash = [];
    for (var i = 0; i < arr.length; i++) {
        if (hash.indexOf(arr[i]) == -1) {
            hash.push(arr[i]);
        }
    }
    return hash;
}

function base64Encode(input) {
    var rv;
    rv = encodeURIComponent(input);
    rv = unescape(rv);
    rv = window.btoa(rv);
    return rv;
}
function getUrlParam(name){
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    var r = window.location.search.substr(1).match(reg);
    if(r != null) return decodeURI(r[2]);
    return null;
}